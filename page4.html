<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8"> 
  <title>Γραφήματα Κατηγοριών</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Αποτελέσματα Χρήστη</h2>
  <div class="chart-box">
    <div id="spinner-pieCharts" class="spinner"></div> 
      <div id="pieChartsContainer" class="chart-wrapper pie-charts" style="display:none;"></div>
      <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
          <button class="download-btn" onclick="downloadChartImage('pieChartsContainer', 'Γράφημα Αποτελεσμάτων')">Λήψη Εικόνας</button>
     </div>
  </div>

 <div class="main-content">
  <h2>Μέσος Όρος Ανά Διάσταση</h2>
  <div class="chart-wrapper">
    <div class="chart-box">
      <div class="spinner" id="spinner-categoryChart"></div>
      <canvas id="categoryChart"></canvas>
      <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
          <button class="download-btn" onclick="downloadChartImage('categoryChart', 'ΜΟ')">Λήψη Εικόνας</button>
    </div>
 </div>
</div>

  <h2>Μέσος Όρος Ερωτήσεων Ανά Διάσταση</h2>
  <div class="chart-wrapper">
    <div class="chart-box">
      <h3>Ανθρωποκεντρικότητα <br>(Ερώτηση 1 - Ερώτηση 9)</h3>
      <div class="spinner" id="spinner-category1Chart"></div>
      <canvas id="category1Chart"></canvas>
      <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
          <button class="download-btn" onclick="downloadChartImage('category1Chart', 'ΜΟ_Ανθρωποκεντρικότητας')">Λήψη Εικόνας</button>
      </div>
    </div>

    <div class="chart-box">
      <h3>Κλινική Αποτελεσματικότητα <br>(Ερώτηση 10 - Ερώτηση 13)</h3>
      <div class="spinner" id="spinner-category2Chart"></div>
      <canvas id="category2Chart"></canvas>
      <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
          <button class="download-btn" onclick="downloadChartImage('category1Chart', 'ΜΟ_Ανθρωποκεντρικότητας')">Λήψη Εικόνας</button>
      </div>
    </div>

    <div class="chart-box">
      <h3>Ασφάλεια - Απόρρητο <br>(Ερώτηση 14 - Ερώτηση 16)</h3>
      <div class="spinner" id="spinner-category3Chart"></div>
      <canvas id="category3Chart"></canvas>
      <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
          <button class="download-btn" onclick="downloadChartImage('category1Chart', 'ΜΟ_Ανθρωποκεντρικότητας')">Λήψη Εικόνας</button>
      </div>
    </div>
  </div>

    <h2>Τυπική Απόκλιση Ανά Κατηγορία</h2>
    <div class="chart-wrapper">
    <div class="chart-box">
        <div class="spinner" id="spinner-stdDevCategoryChart"></div>
        <canvas id="stdDevCategoryChart"></canvas>
        <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
          <button class="download-btn" onclick="downloadChartImage('category1Chart', 'ΜΟ_Ανθρωποκεντρικότητας')">Λήψη Εικόνας</button>
        </div>
      </div>
    </div>

    <h2>Τυπική Απόκλιση Ερωτήσεων Ανά Κατηγορία</h2>
    <div class="chart-wrapper">
    <div class="chart-box">
        <h3>Ανθρωποκεντρικότητα <br>(Ερώτηση 1 - Ερώτηση 9)</h3>
        <div class="spinner" id="spinner-stdDevCategory1Chart"></div>
        <canvas id="stdDevCategory1Chart"></canvas>
        <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
             <button class="download-btn" onclick="downloadChartImage('category1Chart', 'ΜΟ_Ανθρωποκεντρικότητας')">Λήψη Εικόνας</button>
      </div>
    </div>

    <div class="chart-box">
        <h3>Κλινική Αποτελεσματικότητα <br>(Ερώτηση 10 - Ερώτηση 13)</h3>
        <div class="spinner" id="spinner-stdDevCategory2Chart"></div>
        <canvas id="stdDevCategory2Chart"></canvas>
        <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
            <button class="download-btn" onclick="downloadChartImage('category1Chart', 'ΜΟ_Ανθρωποκεντρικότητας')">Λήψη Εικόνας</button>
        </div>
    </div>

    <div class="chart-box">
        <h3>Ασφάλεια - Απόρρητο <br>(Ερώτηση 14 - Ερώτηση 16)</h3>
        <div class="spinner" id="spinner-stdDevCategory3Chart"></div>
        <canvas id="stdDevCategory3Chart"></canvas>
        <div class="downloadButtons" style="display: none; text-align: center; margin-top: 20px;">
            <button class="download-btn" onclick="downloadChartImage('category1Chart', 'ΜΟ_Ανθρωποκεντρικότητας')">Λήψη Εικόνας</button>
      </div>
    </div>
  </div>

    <div style="text-align: center; margin: 40px 0;">
      <button onclick="downloadAllCharts()" style="
        padding: 10px 20px;
        font-size: 16px;
        background-color: #4f46e5;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      ">
        ⬇️ Λήψη Όλων των Γραφημάτων
      </button>
    </div>


    </div>
      <p class="switch-page">
         <b>Για να αξιολογήσετε νέα υπηρεσία πατήστε <a href="ins.html">εδώ</a>.</b><br>
          Για να επιστρέψετε στην αρχική σελίδα πατήστε <a href="index.html">εδώ</a>.
      </p>
  <script>
  const scriptUrl = "https://script.google.com/macros/s/AKfycbwLq4GsrjigTjy0bgF1_czclUcgk9icc9oUw0GcLk-8fDzhgvrYkrBXKU3eEktmxkTI/exec";
  const colors = [
      'rgba(79, 70, 229, 0.6)',  // Indigo
      'rgba(167, 139, 250, 0.6)', // Purple
      'rgba(34, 197, 94, 0.6)',   // Green
      'rgba(251, 191, 36, 0.6)',  // Yellow
      'rgba(239, 68, 68, 0.6)',   // Red
      'rgba(16, 185, 129, 0.6)',  // Teal
      'rgba(59, 130, 246, 0.6)',  // Blue
      'rgba(245, 158, 11, 0.6)',  // Orange
      'rgba(236, 72, 153, 0.6)'   // Pink
    ];

  const queTitles = {
      q1: "Ικανοποίηση – Εμπειρία – Αποδοχή",
      q2: "Κατανόηση των Πληροφοριών και Εμπιστοσύνη",
      q3: "Ικανότητα Χρήσης της Εφαρμογής – Προσβασιμότητα",
      q4: "Τεχνολογική Υποδομή",
      q5: "Ψηφιακός Αλφαβητισμός",
      q6: "Επικοινωνία",
      q7: "Πρόσβαση στην Φροντίδα για Ασθενείς, Οικογένεια και / ή Φροντιστές",
      q8: "Εμπειρία των Μελών της Ομάδας Φροντίδας",
      q9: "Ηθικές Αρχές - Προώθηση και Μάρκετινγκ",
      q10: "Ετοιμότητα Εργατικού Δυναμικού",
      q11: "Διαγνωστική Ακρίβεια",
      q12: "Επιπτώσεις στη Θνησιμότητα, στη Νοσηρότητα, στην HRQoL, καθώς και στις Συνήθειες - Συμπεριφορές",
      q13: "Χρήση Υπηρεσιών Υγείας",
      q14: "Λειτουργική Ακεραιότητα και Ακεραιότητα Υποδομών",
      q15: "Ψυχολογική και Συναισθηματική Ασφάλεια",
      q16: "Διακυβέρνηση"
    };

  async function fetchAnswers() {
    const response = await fetch(scriptUrl);
    const data = await response.json();
    return data;
  }

  function averageRange(arr, start, end) {
    let sum = 0, count = 0;
    for (let i = start; i <= end; i++) {
      const val = parseFloat(arr[i]);
      if (!isNaN(val)) {
        sum += val;
        count++;
      }
    }
    return count ? (sum / count).toFixed(2) : 0;
  }

  function calculateAverages(data) {
    const questionTotals = Array(17).fill(0);
    const questionCounts = Array(17).fill(0);

    data.forEach(entry => {
      for (let i = 1; i <= 16; i++) {
        const val = parseFloat(entry[`q${i}`]);
        if (!isNaN(val)) {
          questionTotals[i] += val;
          questionCounts[i]++;
        }
      }
    });

    const avgPerQuestion = questionTotals.map((total, i) =>
      questionCounts[i] ? (total / questionCounts[i]).toFixed(2) : 0
    );

    const avgCategory = [
      averageRange(avgPerQuestion, 1, 9),
      averageRange(avgPerQuestion, 10, 13),
      averageRange(avgPerQuestion, 14, 16)
    ];

    return { avgCategory, avgPerQuestion };
  }

  function renderChart(ctx, labels, data, label, colors, stdDevs = null) {
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label,
          data,
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace("0.6", "1")),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true, // Εμφάνιση υπομνήματος
            labels: {
              generateLabels: function(chart) {
                return labels.map((label, index) => ({
                  text: label,
                  fillStyle: colors[index],
                  strokeStyle: colors[index],
                  index: index
                }));
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const stdDev = stdDevs ? ` (Τ.Α.: ${stdDevs[context.dataIndex]})` : '';
                return `${context.dataset.label}: ${value}${stdDev}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 5
          },
          x: {
            display: false  // Απόκρυψη labels κάτω από τις μπάρες
          }
        }
      }
    });

    // Απόκρυψη spinner και εμφάνιση καμβά
    const spinnerId = `spinner-${ctx.id}`;
    const spinner = document.getElementById(spinnerId);
    if (spinner) spinner.style.display = "none";
    ctx.style.display = "block";

    return chart;
  }


  async function createPieChartsPerService(answers) {
    const userIdFromSession = sessionStorage.getItem('userId'); // Παίρνουμε το userId
    const spinner = document.getElementById('spinner-pieCharts');
    const container = document.getElementById('pieChartsContainer');
  
    spinner.style.display = 'block';      // Εμφάνιση spinner πριν ξεκινήσει
    container.style.display = 'none';     // Απόκρυψη περιεχομένου
    // Φιλτράρουμε τις απαντήσεις με βάση το userId
    const filteredAnswers = userIdFromSession 
      ? answers.filter(entry => entry.userId === userIdFromSession) 
      : answers;  // Αν δεν υπάρχει userId στο session, δείξε όλα

    const pieChartsContainer = document.getElementById('pieChartsContainer');
    pieChartsContainer.innerHTML = ''; // Καθαρισμός προηγούμενων

    if (filteredAnswers.length === 0) {
      spinner.style.display = 'none';     // Απόκρυψη spinner
      container.style.display = 'block';  // Εμφάνιση container (με μήνυμα)
      pieChartsContainer.innerHTML = '<p>Δεν βρέθηκαν δεδομένα για τον συγκεκριμένο χρήστη.</p>';
      return;
    }

    // Ομαδοποίηση όπως πριν
    const serviceGroups = {};
    filteredAnswers.forEach(entry => {
      const service = entry.service || 'Άγνωστη Υπηρεσία';
      if (!serviceGroups[service]) {
        serviceGroups[service] = { category1: 0, category2: 0, category3: 0 };
      }
      serviceGroups[service].category1 += parseFloat(entry.category1) || 0;
      serviceGroups[service].category2 += parseFloat(entry.category2) || 0;
      serviceGroups[service].category3 += parseFloat(entry.category3) || 0;
    });

    let index = 0;
    for (const [service, scores] of Object.entries(serviceGroups)) {
      const chartWrapper = document.createElement('div');
      chartWrapper.classList.add('chart-box');
      chartWrapper.innerHTML = `
          <h3>${service}</h3>
          <canvas id="pieChart${index}"></canvas>
          <button onclick="downloadChartImage('pieChart${index}', 'PieChart_${service.replaceAll(' ', '_')}')">
            Λήψη Εικόνας
          </button>
        `;

      pieChartsContainer.appendChild(chartWrapper);

      const ctx = document.getElementById(`pieChart${index}`).getContext('2d');

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Ανθρωποκεντρικότητα', 'Κλινική Αποτελεσματικότητα', 'Απόρρητο - Ασφάλεια'],
          datasets: [{
            label: 'Συνολικό Σκορ',
            data: [scores.category1, scores.category2, scores.category3],
            backgroundColor: colors,
            borderColor: ['#fff', '#fff', '#fff'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.raw.toFixed(2)}`
              }
            }
          }
        }
      });

      index++;
    }
      spinner.style.display = 'none';    // Κρύβουμε το spinner μετά τη φόρτωση
      container.style.display = 'block'; // Εμφανίζουμε τα γραφήματα
  }


  async function initCharts() {
    const answers = await fetchAnswers();
    createPieChartsPerService(answers);
    const { avgCategory, avgPerQuestion } = calculateAverages(answers);

    function calculateStdDev(arr) {
      const n = arr.length;
      if (n === 0) return 0;
      const mean = arr.reduce((a, b) => a + b, 0) / n;
      const variance = arr.reduce((a, b) => a + (b - mean) ** 2, 0) / n;
      return Math.sqrt(variance).toFixed(2);
    }

    function getAnswersPerQuestion(data, questionNumber) {
      return data
        .map(entry => parseFloat(entry[`q${questionNumber}`]))
        .filter(val => !isNaN(val));
    }

    const stdDevPerQuestion = [];
    for (let i = 1; i <= 16; i++) {
      const answersQ = getAnswersPerQuestion(answers, i);
      stdDevPerQuestion[i] = parseFloat(calculateStdDev(answersQ));
    }

    const stdDevCategory = [
      averageRange(stdDevPerQuestion, 1, 9),
      averageRange(stdDevPerQuestion, 10, 13),
      averageRange(stdDevPerQuestion, 14, 16)
    ];

    const stdDevCategory1Questions = stdDevPerQuestion.slice(1, 10); // Q1 - Q9
    const stdDevCategory2Questions = stdDevPerQuestion.slice(10, 14); // Q10 - Q13
    const stdDevCategory3Questions = stdDevPerQuestion.slice(14, 17); // Q14 - Q16


    renderChart(
      document.getElementById('categoryChart'),
      ['Ανθρωποκεντρικότητα', 'Κλινική Αποτελεσματικότητα', 'Ασφάλεια - Απόρρητο'],
      avgCategory,
      'Μ.Ο. Κατηγορίας',
      [colors[0], colors[1], colors[2]]
    );

    renderChart(
      document.getElementById('category1Chart'),
      Array.from({ length: 9 }, (_, i) => queTitles[`q${i + 1}`]),
      avgPerQuestion.slice(1, 10),
      'Ανθρωποκεντρικότητα',
      colors.slice(0, 9)
    );

    renderChart(
      document.getElementById('category2Chart'),
      ['q10', 'q11', 'q12', 'q13'].map(key => queTitles[key]),
      avgPerQuestion.slice(10, 14),
      'Κλινική Αποτελεσματικότητα',
      colors.slice(3, 7)
    );

    renderChart(
      document.getElementById('category3Chart'),
      ['q14', 'q15', 'q16'].map(key => queTitles[key]),
      avgPerQuestion.slice(14, 17),
      'Ασφάλεια - Απόρρητο',
      colors.slice(6, 9)
    );

    renderChart(
      document.getElementById('stdDevCategoryChart'),
      ['Ανθρωποκεντρικότητα', 'Κλινική Αποτελεσματικότητα', 'Ασφάλεια - Απόρρητο'],
      stdDevCategory,
      'Τυπική Απόκλιση',
      [colors[3], colors[4], colors[5]]
    );

    renderChart(
        document.getElementById('stdDevCategory1Chart'),
        Array.from({ length: 9 }, (_, i) => queTitles[`q${i + 1}`]),
        stdDevCategory1Questions,
        'Τυπική Απόκλιση - Ανθρωποκεντρικότητα',
        colors.slice(0, 9)
        );

        renderChart(
        document.getElementById('stdDevCategory2Chart'),
        ['q10', 'q11', 'q12', 'q13'].map(key => queTitles[key]),
        stdDevCategory2Questions,
        'Τυπική Απόκλιση - Κλινική Αποτελεσματικότητα',
        colors.slice(3, 7)
        );

        renderChart(
        document.getElementById('stdDevCategory3Chart'),
        ['q14', 'q15', 'q16'].map(key => queTitles[key]),
        stdDevCategory3Questions,
        'Τυπική Απόκλιση - Ασφάλεια - Απόρρητο',
        colors.slice(6, 9)
    );

    document.querySelectorAll('.downloadButtons').forEach(el => el.style.display = "block");
  }

  
  initCharts();

    // Όλα τα containers των γραφημάτων
  const chartBoxes = document.querySelectorAll('.chart-box');

  chartBoxes.forEach(box => {
    box.addEventListener('click', () => {
      // Αφαιρούμε highlight από όλα
      chartBoxes.forEach(b => b.classList.remove('highlighted'));
      // Προσθέτουμε highlight στο πατημένο
      box.classList.add('highlighted');
    });
  });

    function downloadChartImage(canvasId, fileName) {
      const canvas = document.getElementById(canvasId);
      const url = canvas.toDataURL("image/png");

      const link = document.createElement("a");
      link.href = url;
      link.download = `${fileName}.png`;
      link.click();
  }

  function downloadAllCharts() {
    const canvases = document.querySelectorAll("canvas");
    canvases.forEach((canvas, index) => {
      const fileName = `chart_${canvas.id || index}`;
      const url = canvas.toDataURL("image/png");

      const link = document.createElement("a");
      link.href = url;
      link.download = `${fileName}.png`;
      link.click();
    });
  }

</script>

</body>
</html>